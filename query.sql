SELECT m.message_id, m.content, m.attachments, m.jump_url, COALESCE(mem.server_nick, mem.global_name, mem.username) as author_name, CASE WHEN m.reactors IS NULL OR m.reactors = '[]' THEN 0 ELSE json_array_length(m.reactors) END as unique_reactor_count, m.created_at, c.channel_name FROM messages m JOIN members mem ON m.author_id = mem.member_id JOIN channels c ON m.channel_id = c.channel_id WHERE m.created_at > datetime('now', '-1 day') AND json_valid(m.attachments) AND m.attachments != '[]' AND LOWER(c.channel_name) NOT LIKE '%nsfw%' AND EXISTS (SELECT 1 FROM json_each(m.attachments) WHERE LOWER(json_extract(value, '$.filename')) LIKE '%.mp4' OR LOWER(json_extract(value, '$.filename')) LIKE '%.mov' OR LOWER(json_extract(value, '$.filename')) LIKE '%.webm') AND (CASE WHEN m.reactors IS NULL OR m.reactors = '[]' THEN 0 ELSE json_array_length(m.reactors) END) >= 3 ORDER BY unique_reactor_count DESC;
